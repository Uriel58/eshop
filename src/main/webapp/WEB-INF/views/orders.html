<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Order Details</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
</head>
<body>
	<div class="container mt-4">
		<h2 th:text="${name != null} ? ${'Hello！ ' + name} : 'Hello！ visitor'"></h2>

		<a th:href="@{/}" class="btn btn-outline-secondary mb-3">Back</a> <a
			th:href="@{/orders/add}" class="btn btn-primary mb-3">Add New
			Order</a>
		<!-- 
	    * Order有ord_num(訂單編號),ord_date(創建訂單日期,自動),required_date(更新訂單日期,自動),county(購買地區),cust_num（顧客編號),
	    * order_status(訂單狀態),payment_method(付款方式),order_barcode(訂單條碼,自動)
	    
	    * OrderDetail有ord_num(訂單編號)不顯示,prodNum(產品編號),ord_qty(訂單數量),ord_price(總共產品價格),
	    * prod_price(各產品價格),fare(運費)
		 -->
		<h3>Order Information</h3>
		<table class="table table-bordered">
			<thead>
				<tr>
					<th>Order Number</th>
					<th>Order Date</th>
					<th>Update Date</th>
					<th>County</th>
					<th>Customer Number</th>
					<th>Status</th>
					<th>Payment Method</th>
					<th>Order Barcode</th>

					<th>Product Number</th>
					<th>Price Each</th>
					<th>Quantity Ordered</th>
					<th>Total Price (ord_price)</th>
					<th>Fare</th>
					<th>Actions</th>
				</tr>
			<!--<tbody>
				<tr th:each="order : ${orders}">
					<td th:text="${order.ordNum}" rowspan="${#lists.size(order.orderDetails)}"></td>
					<td th:text="${order.ordDate}" rowspan="${#lists.size(order.orderDetails)}"></td>
					<td th:text="${order.requiredDate}" rowspan="${#lists.size(order.orderDetails)}"></td>
					<td th:text="${order.county}" rowspan="${#lists.size(order.orderDetails)}"></td>
					<td th:text="${order.custNum}" rowspan="${#lists.size(order.orderDetails)}"></td>
					<td th:text="${order.orderStatus}" rowspan="${#lists.size(order.orderDetails)}"></td>
					<td th:text="${order.paymentMethod}" rowspan="${#lists.size(order.orderDetails)}"></td>
					<td th:text="${order.orderBarcode}" rowspan="${#lists.size(order.orderDetails)}"></td>
				</tr>

				<tr th:each="detail : ${orders.orderDetails}">
					<span th:text="${detail.prodNum}"></span> /
					<span th:text="${detail.ord_price}"></span> / 
					<span th:text="${detail.ordqty}"></span> /
					<span th:text="${detail.fare}"></span>
				</tr>
				<tr>
					<td><a
						th:href="@{/orders/details/{ordNum}/delete-detail/{prodNum}(ordNum=${detail.ordNum},prodNum=${detail.prodNum})}"
						class="btn btn-danger btn-sm"
						onclick="return confirm('Are you sure you want to delete this detail?');">
							Delete </a></td>
				</tr>
			</tbody>-->
			<!-- 第一層：遍歷每筆訂單 -->
			<tr th:each="order : ${orders}">
				<!-- 主檔資料 -->
				<td th:text="${order.ordNum}" rowspan="${#lists.size(order.orderDetails)}"></td>
				<td th:text="${order.ordDate}" rowspan="${#lists.size(order.orderDetails)}"></td>
				<td th:text="${order.requiredDate}" rowspan="${#lists.size(order.orderDetails)}"></td>
				<td th:text="${order.county}" rowspan="${#lists.size(order.orderDetails)}"></td>
				<td th:text="${order.custNum}" rowspan="${#lists.size(order.orderDetails)}"></td>
				<td th:text="${order.orderStatus}" rowspan="${#lists.size(order.orderDetails)}"></td>
				<td th:text="${order.paymentMethod}" rowspan="${#lists.size(order.orderDetails)}"></td>
				<td th:text="${order.orderBarcode}" rowspan="${#lists.size(order.orderDetails)}"></td>

				<!-- 明細第一筆 -->
				<td th:text="${order.orderDetails[0].prodNum}"></td>
				<td th:text="${order.orderDetails[0].product != null ? order.orderDetails[0].product.prodPrice : 'N/A'}"></td>
				<td th:text="${order.orderDetails[0].ordQty}"></td>
				<td th:text="${order.orderDetails[0].ordPrice}"></td>
				<td th:text="${order.orderDetails[0].fare}"></td>
				<td>
					<a th:href="@{/orders/details/{ordNum}/delete-detail/{prodNum}(ordNum=${order.orderDetails[0].ordNum}, prodNum=${order.orderDetails[0].prodNum})}"
					   class="btn btn-danger btn-sm"
					   onclick="return confirm('Are you sure you want to delete this detail?');">Delete</a>
				</td>
			</tr>

			<!-- 第二層：遍歷除了第一筆以外的明細 -->
			<tr th:each="detail, iterStat : ${order.orderDetails}"
			    th:if="${iterStat.index > 0}">
				<td th:text="${detail.prodNum}"></td>
				<td th:text="${detail.product != null ? detail.product.prodPrice : 'N/A'}"></td>
				<td th:text="${detail.ordQty}"></td>
				<td th:text="${detail.ordPrice}"></td>
				<td th:text="${detail.fare}"></td>
				<td>
					<a th:href="@{/orders/details/{ordNum}/delete-detail/{prodNum}(ordNum=${detail.ordNum}, prodNum=${detail.prodNum})}"
					   class="btn btn-danger btn-sm"
					   onclick="return confirm('Are you sure you want to delete this detail?');">Delete</a>
				</td>
			</tr>
			<!-- 結束巢狀 -->
		</tbody>
		</table>


		<a th:href="@{/logout}" class="btn btn-danger mt-4">Logout</a>
	</div>
</body>
</html>
