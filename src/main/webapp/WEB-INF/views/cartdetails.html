<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Cart Details</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<style>
.product-card {
	border: 1px solid #e0e0e0;
	padding: 10px;
	margin-bottom: 20px;
	box-shadow: 2px 2px 5px #ccc;
	transition: transform 0.2s ease-in-out;
}

.product-card:hover {
	transform: scale(1.03);
}

.product-image {
	width: 100%;
	height: 200px;
	object-fit: cover;
}

.price {
	color: black;
	font-weight: bold;
	font-size: 1.2rem;
}

.cart-total {
	font-weight: bold;
	font-size: 1.5rem;
	color: #d9534f;
}
</style>
</head>
<body>
	<div class="container mt-4">
		<h2>Cart Details</h2>
		<!--
		* 不顯示ord_date,required_date,customer_id,ord_num,
		* 需要有ord_num,county,delivery_method,order_barcode,order_status,
		* payment_method,fare,ord_price,ord_qty,prodNum,ord_price
		 -->
		<!-- 顯示購物車明細 -->
		<div class="row">
			<div class="col-md-12">
				<div class="table-responsive">
					<table class="table table-bordered">
						<thead>
							<tr>
								<th>商品名稱</th>
								<th>商品圖片</th>
								<th>價格</th>
								<th>數量</th>
								<th>運費</th>
								<th>總價</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody>
							<!-- 顯示每個商品 -->
							<tr th:each="detail : ${details}">
								<td th:text="${detail.product.prodName}">商品名稱</td>
								<td><img
									th:src="@{'/resources/images/' + ${detail.product.prodImages}}"
									class="product-image" alt="Product Image"></td>
								<td
									th:text="${#numbers.formatDecimal(detail.prodPrice, 0, 'COMMA', 2, 'POINT')} + ' 元'">價格</td>
								<td>
									<form
										th:action="@{/cart/{cartId}/update-product(cartId=${cart.id})}"
										method="post">
										<input type="number" th:name="quantity"
											th:value="${detail.cartQty}" class="form-control" min="1">
										<input type="hidden" th:name="productId"
											th:value="${detail.product.prodNum}" />
										<!-- ✅ 新增 hidden input 存運送方式 -->
										<input type="hidden" name="deliveryMethod"
											id="selectedDelivery" th:value="*{deliveryMethod}"  />
										<button type="submit" class="btn btn-primary mt-2">更新數量</button>
									</form>
								</td>
								<!-- ✅ 運費欄位 -->
								
								<td class="shipping-fee" th:if="${deliveryMethod}">
									<span th:text="${#numbers.formatDecimal(detail.shippingFee, 0, 'COMMA', 2, 'POINT')} + ' 元'">運費</span>
									</td>
								<td class="shipping-fee" th:unless="${deliveryMethod}">
									<span>0元</span>
								</td>
									

								<!-- ✅ 小計加上 class=item-total -->
								<td class="item-total"
									th:text="${#numbers.formatDecimal(detail.cartTotal, 0, 'COMMA', 2, 'POINT')} + ' 元'" th:attr="data-base=${detail.cartTotal}">總價</td>
								<td>
									<!-- 刪除商品 --> <a
									th:href="@{/cart/{cartId}/remove-product/{productId}(cartId=${cart.id}, productId=${detail.product.prodNum})}"
									class="btn btn-danger">刪除</a>
								</td>
							</tr>
						</tbody>
					</table>
				</div>

				<!-- 顯示購物車總計 -->
				<div id="cart-total-container"
					class="d-flex justify-content-between align-items-center mt-4">
					<h3 class="cartTotal" th:if="${total != null and total > 0}">
						總價: <span id="cart-total-value"
							th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 2, 'POINT')} + ' 元'"></span>
					</h3>
					<h3  class="cartTotal" th:unless="${total != null and total > 0}">
						總價: <span>0.00元</span>
					</h3>
				</div>
				<form th:action="@{/cart/{cartId}/checkout(cartId=${cart.id})}"
					method="post" th:object="${order}">
					<div class="mb-3">
						<div class="mb-3">
							<label>County</label> <select th:field="*{county}"
								class="form-control">
								<option value="">-- Select --</option>
								<option value="台北市">台北市</option>
								<option value="新北市">新北市</option>
								<option value="台中市">台中市</option>
								<option value="高雄市">高雄市</option>
								<option value="台南市">台南市</option>
								<option value="桃園市">桃園市</option>
								<option value="新竹市">新竹市</option>
								<option value="嘉義市">嘉義市</option>
								<option value="基隆市">基隆市</option>
								<option value="新竹縣">新竹縣</option>
								<option value="苗栗縣">苗栗縣</option>
								<option value="彰化縣">彰化縣</option>
								<option value="南投縣">南投縣</option>
								<option value="雲林縣">雲林縣</option>
								<option value="嘉義縣">嘉義縣</option>
								<option value="屏東縣">屏東縣</option>
								<option value="宜蘭縣">宜蘭縣</option>
								<option value="花蓮縣">花蓮縣</option>
								<option value="台東縣">台東縣</option>
								<option value="澎湖縣">澎湖縣</option>
								<option value="金門縣">金門縣</option>
								<option value="連江縣">連江縣</option>
							</select>
						</div>
						<div class="mb-3">
							<label>Payment Method</label><br /> <input type="radio"
								th:field="*{paymentMethod}" value="CASH" /> 現金 <input
								type="radio" th:field="*{paymentMethod}" value="CREDIT_CARD" />
							刷卡 <input type="radio" th:field="*{paymentMethod}"
								value="E_PAYMENT" /> 電子支付
						</div>
						<div class="mb-3">
							<label>Delivery Method</label><br /> <input type="radio"
								th:field="*{deliveryMethod}" th:checked="${order.deliveryMethod == 'PICK_UP'}" value="PICK_UP" /> 自取(PICK_UP) <input
								type="radio" th:field="*{deliveryMethod}" th:checked="${order.deliveryMethod == 'HOME_DELIVERY'}" value="HOME_DELIVERY" />
							宅配到府 (HOME_DELIVERY) <input type="radio"
								th:field="*{deliveryMethod}"  th:checked="${order.deliveryMethod == 'STORE_DELIVERY'}" value="STORE_DELIVERY" /> 超商取貨
							(STORE_DELIVERY) <input type="radio" th:field="*{deliveryMethod}"
								 th:checked="${order.deliveryMethod == 'POSTAL'}" value="POSTAL" /> 郵寄 (POSTAL)
						</div>
						<button type="submit" class="btn btn-success">結帳</button>
				</form>
			</div>
			<!-- 返回購物車列表 -->
			<div class="mt-4">
				<a th:href="@{/}" class="btn btn-secondary">返回商品列表</a>
			</div>
		</div>
	</div>
	<!-- ✅ JS：動態更新運費與總價 -->
	<script>
	document.addEventListener("DOMContentLoaded", function () {
	    const deliveryRadios = document.querySelectorAll("input[name='deliveryMethod']");
	    const shippingFeeCells = document.querySelectorAll(".shipping-fee");
	    const totalSpan = document.getElementById("cart-total-value");
	    const hiddenDeliveryInputs = document.querySelectorAll("input#selectedDelivery");

	    // 取得原始總價
	    let baseTotal = 0;
	    document.querySelectorAll(".item-total").forEach(cell => {
	        baseTotal += parseFloat(cell.dataset.base) || 0;
	    });

	    function updateTotal(fee) {
	        totalSpan.textContent = (baseTotal + fee).toFixed(2) + " 元";
	    }

	    deliveryRadios.forEach(radio => {
	        radio.addEventListener("change", function () {
	            let fee = 0;
	            switch(this.value) {
	                case "HOME_DELIVERY": fee = 24; break;
	                case "POSTAL": fee = 12; break;
	                case "STORE_DELIVERY": fee = 6; break;
	                default: fee = 0; break;
	            }

	            // 更新運費
	            shippingFeeCells.forEach(cell => cell.textContent = fee + " 元");

	            // 更新 hidden input
	            hiddenDeliveryInputs.forEach(input => input.value = radio.value);

	            // 更新總價
	            updateTotal(fee);
	        });
	    });

	    // 預設選中運送方式時初始化
	    const selectedRadio = document.querySelector("input[name='deliveryMethod']:checked");
	    if(selectedRadio) selectedRadio.dispatchEvent(new Event('change'));
	});

</script>

</body>
</html>
