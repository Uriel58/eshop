<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title th:text="#{a.shopping_cart}">Shopping Cart</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<style>
.product-card {
	border: 1px solid #e0e0e0;
	padding: 10px;
	margin-bottom: 20px;
	box-shadow: 2px 2px 5px #ccc;
	transition: transform 0.2s ease-in-out;
}

.product-card:hover {
	transform: scale(1.03);
}

.product-image {
	width: 100%;
	height: 200px;
	object-fit: cover;
}

.price {
	color: black;
	font-weight: bold;
	font-size: 1.2rem;
}

.cart-total {
	font-weight: bold;
	font-size: 1.5rem;
	color: #d9534f;
}
</style>
</head>
<body>
	<div class="container mt-4">
		<h2 th:text="#{a.shopping_cart}">Shopping Cart</h2>
		<!-- 顯示購物車明細 -->
		<div class="row">
			<div class="col-md-12">
				<div class="table-responsive">
					<table class="table table-bordered">
						<thead>
							<tr>
								<th th:text="#{a.product_name}">Product Name</th>
								<th th:text="#{a.product_images}">Product Images</th>
								<th th:text="#{a.price}">Price</th>
								<th th:text="#{a.quantity_of_products}">Quantity of
									products</th>
								<th th:text="#{a.fare}">Fare</th>
								<th th:text="#{a.total_price}">Total Price</th>
								<th th:text="#{a.operate}">Operate</th>
							</tr>
						</thead>
						<tbody>
							<!-- 顯示每個商品 -->
							<tr th:each="detail : ${details}">
								<td th:text="${detail.product.prodName}">Product Name</td>
								<td>
									<!-- 有圖片時顯示 --> <img
									th:if="${detail.product != null 
                 					and detail.product.prodImages != null 
                 					and !detail.product.prodImages.isEmpty()}"
									th:src="@{${detail.product.prodImages}}"
									th:alt="${detail.product.prodName}" class="product-image"
									onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />

									<!-- 圖片載入失敗時顯示 -->
									<div class="no-image" style="display: none;">無圖片</div> <!-- prodImages 為 null 或空字串時直接顯示 -->
									<div
										th:if="${detail.product == null 
                 						or detail.product.prodImages == null 
                 						or detail.product.prodImages.isEmpty()}"
										class="no-image">無圖片</div>
								</td>
								<td
									th:text="${#numbers.formatDecimal(detail.prodPrice, 0, 'COMMA', 2, 'POINT')} + ' ' + #{a.dollar}">Price</td>
								<td>
									<div class="d-flex align-items-center gap-2">
										<input type="number"
											th:id="'qty-' + ${detail.product.prodNum}"
											th:value="${detail.cartQty}" class="form-control qty-input"
											min="1" style="width: 80px;"
											th:data-product-id="${detail.product.prodNum}">
										<button type="button"
											class="btn btn-primary btn-sm update-qty-btn"
											th:data-cart-id="${cart.id}"
											th:data-product-id="${detail.product.prodNum}"
											th:text="#{a.update}">update</button>
									</div>
								</td>
								<!-- ✅ 運費欄位 -->
								<td class="shipping-fee"
									th:attr="data-fee=${detail.shippingFee != null ? detail.shippingFee : 0}">
									<span
									th:text="${detail.shippingFee != null ? #numbers.formatDecimal(detail.shippingFee, 0, 'COMMA', 2, 'POINT')  : '0.00' } + ' ' + #{a.dollar}">運費</span>
								</td>

								<!-- ✅ 小計 = 商品價格 × 數量 (不含運費) -->
								<td class="item-total"
									th:text="${#numbers.formatDecimal(detail.cartTotal, 0, 'COMMA', 2, 'POINT')} + ' ' + #{a.dollar}"
									th:attr="data-base=${detail.prodPrice * detail.cartQty}">Total
									Price</td>
								<td>
									<!-- 刪除商品 --> <a
									th:href="@{/cart/{cartId}/remove-product/{productId}(cartId=${cart.id}, productId=${detail.product.prodNum})}"
									class="btn btn-danger btn-sm" th:text="#{a.delete}">delete</a>
								</td>
							</tr>
						</tbody>
					</table>
				</div>

				<!-- 顯示購物車總計 -->
				<div id="cart-total-container"
					class="d-flex justify-content-between align-items-center mt-4">
					<h3 class="cartTotal" th:if="${total != null and total > 0}">
						<span th:text="#{a.total_price} + ': '">Total Price: </span><span
							id="cart-total-value"
							th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 2, 'POINT')} + ' ' + #{a.dollar}"></span>
					</h3>
					<h3 class="cartTotal" th:unless="${total != null and total > 0}">
						<span th:text="#{a.total_price} + ': '">Total Price: </span><span
							id="cart-total-value" th:text="'0.00 ' + #{a.dollar}">0.00
							dollar</span>
					</h3>
				</div>
				<form th:action="@{/cart/{cartId}/checkout(cartId=${cart.id})}"
					method="post" th:object="${order}" id="checkoutForm">
					<div class="mb-3">
						<div class="mb-3">
							<label th:text="#{a.county}">County</label> <select
								th:field="*{county}" class="form-control" id="countySelect">
								<option value="" th:text="#{a.select}">-- Select --</option>
								<option value="台北市">台北市</option>
								<option value="新北市">新北市</option>
								<option value="台中市">台中市</option>
								<option value="高雄市">高雄市</option>
								<option value="台南市">台南市</option>
								<option value="桃園市">桃園市</option>
								<option value="新竹市">新竹市</option>
								<option value="嘉義市">嘉義市</option>
								<option value="基隆市">基隆市</option>
								<option value="新竹縣">新竹縣</option>
								<option value="苗栗縣">苗栗縣</option>
								<option value="彰化縣">彰化縣</option>
								<option value="南投縣">南投縣</option>
								<option value="雲林縣">雲林縣</option>
								<option value="嘉義縣">嘉義縣</option>
								<option value="屏東縣">屏東縣</option>
								<option value="宜蘭縣">宜蘭縣</option>
								<option value="花蓮縣">花蓮縣</option>
								<option value="台東縣">台東縣</option>
								<option value="澎湖縣">澎湖縣</option>
								<option value="金門縣">金門縣</option>
								<option value="連江縣">連江縣</option>
							</select>
						</div>
						<div class="mb-3">
							<label th:text="#{a.payment_method}">Payment Method</label><br />
							<input type="radio" th:field="*{paymentMethod}" value="CASH"
								id="payCash" /> 現金 <input type="radio"
								th:field="*{paymentMethod}" value="CREDIT_CARD" id="payCredit" />
							刷卡 <input type="radio" th:field="*{paymentMethod}"
								value="E_PAYMENT" id="payEPay" /> 電子支付
						</div>
						<div class="mb-3">
							<label th:text="#{a.delivery_method}">Delivery Method</label><br />
							<input type="radio" th:field="*{deliveryMethod}"
								th:checked="${order.deliveryMethod == 'PICK_UP'}"
								value="PICK_UP" id="deliveryPickUp" /> 自取(PICK_UP) <input
								type="radio" th:field="*{deliveryMethod}"
								th:checked="${order.deliveryMethod == 'HOME_DELIVERY'}"
								value="HOME_DELIVERY" id="deliveryHome" /> 宅配到府 (HOME_DELIVERY)
							<input type="radio" th:field="*{deliveryMethod}"
								th:checked="${order.deliveryMethod == 'STORE_DELIVERY'}"
								value="STORE_DELIVERY" id="deliveryStore" /> 超商取貨
							(STORE_DELIVERY) <input type="radio" th:field="*{deliveryMethod}"
								th:checked="${order.deliveryMethod == 'POSTAL'}" value="POSTAL"
								id="deliveryPostal" /> 郵寄 (POSTAL)
						</div>
						<button type="submit" class="btn btn-success"
							th:text="#{a.checkout}">checkout</button>
					</div>
				</form>

				<!-- 返回購物車列表 -->
				<div class="mt-4">
					<a th:href="@{/}" class="btn btn-secondary" th:text="#{a.back}">back</a>
				</div>
			</div>
		</div>
	</div>
	<!-- ✅ JS：動態更新運費與總價 + 保存表單狀態 -->
	<script th:inline="javascript">
	document.addEventListener("DOMContentLoaded", function () {
	    const deliveryRadios = document.querySelectorAll("input[name='deliveryMethod']");
	    const shippingFeeCells = document.querySelectorAll(".shipping-fee");
	    const itemTotalCells = document.querySelectorAll(".item-total");
	    const totalSpan = document.getElementById("cart-total-value");
	    const countySelect = document.getElementById("countySelect");
	    const paymentRadios = document.querySelectorAll("input[name='paymentMethod']");
	    
	    // ✅ 使用 Thymeleaf 內聯表達式取得 i18n 文字
	    const dollar_Text = /*[[#{a.dollar}]]*/ 'dollar';
	    
	    // 運費設定
	    const shippingFees = {
	        "PICK_UP": 0,
	        "HOME_DELIVERY": 24,
	        "POSTAL": 12,
	        "STORE_DELIVERY": 6
	    };

	    // ===== 數字格式化函數（加上千分位逗號）=====
	    function formatNumber(num) {
	        return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	    }

	    // ===== 表單狀態保存與恢復 =====
	    function saveFormState() {
	        const selectedDelivery = document.querySelector("input[name='deliveryMethod']:checked");
	        const selectedPayment = document.querySelector("input[name='paymentMethod']:checked");
	        
	        localStorage.setItem('cartCounty', countySelect.value);
	        localStorage.setItem('cartDelivery', selectedDelivery ? selectedDelivery.value : '');
	        localStorage.setItem('cartPayment', selectedPayment ? selectedPayment.value : '');
	    }

	    function restoreFormState() {
	        const savedCounty = localStorage.getItem('cartCounty');
	        const savedDelivery = localStorage.getItem('cartDelivery');
	        const savedPayment = localStorage.getItem('cartPayment');

	        if (savedCounty) countySelect.value = savedCounty;
	        
	        if (savedDelivery) {
	            const deliveryRadio = document.querySelector(`input[name='deliveryMethod'][value='${savedDelivery}']`);
	            if (deliveryRadio) {
	                deliveryRadio.checked = true;
	                updateTotal(savedDelivery);
	            }
	        }
	        
	        if (savedPayment) {
	            const paymentRadio = document.querySelector(`input[name='paymentMethod'][value='${savedPayment}']`);
	            if (paymentRadio) paymentRadio.checked = true;
	        }
	    }

	    // 監聽表單變更並保存
	    countySelect.addEventListener('change', saveFormState);
	    paymentRadios.forEach(radio => radio.addEventListener('change', saveFormState));
	    deliveryRadios.forEach(radio => radio.addEventListener('change', saveFormState));

	    // ===== 運費與總價計算 =====
	    function updateTotal(selectedMethod) {
	        const fee = shippingFees[selectedMethod] || 0;
	        let grandTotal = 0;

	        // 更新每個商品的運費顯示
	        shippingFeeCells.forEach(cell => {
	            cell.querySelector('span').textContent = formatNumber(fee) + " " + dollar_Text;
	            cell.setAttribute('data-fee', fee);
	        });

	        // 計算總價：每個商品小計 + 對應運費
	        itemTotalCells.forEach((cell, index) => {
	            const basePrice = parseFloat(cell.getAttribute('data-base')) || 0;
	            const itemTotal = basePrice + fee;
	            cell.textContent = formatNumber(itemTotal) + " " + dollar_Text;
	            grandTotal += itemTotal;
	        });

	        // 更新總價顯示
	        totalSpan.textContent = formatNumber(grandTotal) + " " + dollar_Text;
	    }

	    // 監聽運送方式變更
	    deliveryRadios.forEach(radio => {
	        radio.addEventListener("change", function () {
	            updateTotal(this.value);
	            saveFormState();
	        });
	    });

	    // ===== 更新數量 =====
	    const updateButtons = document.querySelectorAll('.update-qty-btn');
	    updateButtons.forEach(btn => {
	        btn.addEventListener('click', function() {
	            const cartId = this.dataset.cartId;
	            const productId = this.dataset.productId;
	            const qtyInput = document.getElementById('qty-' + productId);
	            const quantity = qtyInput.value;

	            // 保存表單狀態
	            saveFormState();

	            // 使用傳統表單提交（因為後端是 POST 方法）
	            const form = document.createElement('form');
	            form.method = 'POST';
	            // ✅ 使用相對路徑，會自動包含 context path
	            form.action = window.location.pathname.replace(/\/cartdetails$/, '/update-product');

	            const qtyField = document.createElement('input');
	            qtyField.type = 'hidden';
	            qtyField.name = 'quantity';
	            qtyField.value = quantity;

	            const prodField = document.createElement('input');
	            prodField.type = 'hidden';
	            prodField.name = 'productId';
	            prodField.value = productId;

	            form.appendChild(qtyField);
	            form.appendChild(prodField);
	            document.body.appendChild(form);
	            form.submit();
	        });
	    });

	    // ===== 結帳時清除保存的狀態 =====
	    document.getElementById('checkoutForm').addEventListener('submit', function() {
	        localStorage.removeItem('cartCounty');
	        localStorage.removeItem('cartDelivery');
	        localStorage.removeItem('cartPayment');
	    });

	    // ===== 頁面載入時恢復狀態 =====
	    restoreFormState();

	    // 如果沒有保存的運送方式，使用預設值
	    const selectedRadio = document.querySelector("input[name='deliveryMethod']:checked");
	    if (selectedRadio) {
	        updateTotal(selectedRadio.value);
	    } else {
	        updateTotal("PICK_UP");
	    }
	});
	</script>
</body>
</html>