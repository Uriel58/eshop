<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{a.reset_password}">Reset Password</title>
    <link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        input { margin-bottom: 10px; width: 250px; padding: 5px; }
        button { padding: 5px 10px; }
        .msg { color: red; margin-top: 5px; }
        .msg.success { color: green; }
        .step { margin-bottom: 20px; }
    </style>
</head>
<body>
<h2 th:text="#{a.reset_password}">Reset Password</h2>

<!-- Step 1：輸入 Email -->
<div id="step1" class="step">
    <p th:text="#{a.enter_email} +':'">Please enter your email:</p>
    <input type="email" id="email" th:placeholder="#{a.enter_email}" required>
    <button onclick="requestCode()" th:text="#{a.get_code}">Get verification code</button>
    <p id="msg1" class="msg"></p>
</div>

<!-- Step 2：輸入驗證碼 -->
<div id="step2" class="step" style="display:none;">
    <p th:text="#{a.enter_code} +':'">Please enter the verification code you received:</p>
    <input type="text" id="token" th:placeholder="#{a.six_code}" required>
    <button onclick="verifyCode()"th:text="#{a.verify}">verify</button>
    <p id="msg2" class="msg"></p>
</div>

<!-- Step 3：設定新密碼 -->
<div id="step3" class="step" style="display:none;">
    <p th:text="#{a.please_enter_new_password}">Please enter your new password:</p>
    <input type="password" id="newPassword" th:placeholder="#{a.new_password}" required><br>
    <input type="password" id="confirmPassword" th:placeholder="#{a.enter_new_password_again}" required><br><br>
    <button onclick="resetPassword()" th:text="#{a.confirm}">confirm</button>
    <p id="msg3" class="msg"></p>
</div>

<script th:inline="javascript">
    let tokenValue = '';
    
    // 使用 Thymeleaf 動態取得 contextPath
    const contextPath = /*[[@{/}]]*/ '/';
    const enter_email_Text = /*[[#{a.enter_email}]]*/ 'Please enter your email';
    const verification_code_generated_Text = /*[[#{a.verification_code_generated}]]*/ 'Verification code has been generated (displayed directly for testing purposes)';
    const request_failed_Text = /*[[#{a.request_failed}]]*/ 'Request Failed';
    const network_error_Text = /*[[#{a.network_error}]]*/ 'Network Error';
    const enter_code_Text = /*[[#{a.enter_code}]]*/ 'Please enter the verification code you received';
    const verification_failed_Text = /*[[#{a.verification_failed}]]*/ 'Verification Failed';
    const please_enter_new_password_Text = /*[[#{a.please_enter_new_password}]]*/ 'Please enter your new password';
    const passwords_not_match_Text = /*[[#{a.passwords_not_match}]]*/ 'The two passwords do not match';
    const redirected_login_3s_Text = /*[[#{a.redirected_login_3s}]]*/ 'You will be redirected to the login page in 3 seconds...';
    const reset_failed_Text = /*[[#{a.reset_failed}]]*/ 'Reset Failed';
    
    // Step 1：請求驗證碼
    async function requestCode() {
        const email = document.getElementById("email").value;
        const msg1 = document.getElementById("msg1");
        msg1.textContent = '';

        if (!email) {
            msg1.textContent = enter_email_Text;
            msg1.className = "msg";
            return;
        }

        try {
            const url = `${contextPath}api/password-reset/request?email=${encodeURIComponent(email)}`;
            console.log("Requesting:", url); // 除錯用
            
            const res = await fetch(url, {
                method: "POST"
            });

            const text = await res.text();
            console.log("Response:", res.status, text); // 除錯用
            
            if (res.ok) {
                tokenValue = text;
                msg1.textContent = verification_code_generated_Text + ":" + tokenValue;
                msg1.className = "msg success";
                
                // 切換到 Step 2
                document.getElementById("step1").style.display = "none";
                document.getElementById("step2").style.display = "block";
            } else {
                msg1.textContent = text || request_failed_Text;
                msg1.className = "msg";
            }
        } catch (err) {
            console.error("Error:", err); // 除錯用
            msg1.textContent = network_error_Text + ":" + err;
            msg1.className = "msg";
        }
    }

    // Step 2：驗證驗證碼
    async function verifyCode() {
        const inputToken = document.getElementById("token").value;
        const msg2 = document.getElementById("msg2");
        msg2.textContent = '';

        if (!inputToken) {
            msg2.textContent = enter_code_Text;
            msg2.className = "msg";
            return;
        }

        try {
            const url = `${contextPath}api/password-reset/validate/${encodeURIComponent(inputToken)}`;
            console.log("Validating:", url); // 除錯用
            
            const res = await fetch(url);
            const text = await res.text();
            console.log("Response:", res.status, text); // 除錯用
            
            if (res.ok) {
                msg2.textContent = text;
                msg2.className = "msg success";
                tokenValue = inputToken;
                
                // 切換到 Step 3
                document.getElementById("step2").style.display = "none";
                document.getElementById("step3").style.display = "block";
            } else {
                msg2.textContent = text || verification_failed_Text;
                msg2.className = "msg";
            }
        } catch (err) {
            console.error("Error:", err); // 除錯用
            msg2.textContent = network_error_Text + ":" + err;
            msg2.className = "msg";
        }
    }

    // Step 3：設定新密碼
    async function resetPassword() {
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;
        const msg3 = document.getElementById("msg3");
        msg3.textContent = '';

        if (!newPassword || !confirmPassword) {
            msg3.textContent = please_enter_new_password_Text;
            msg3.className = "msg";
            return;
        }

        if (newPassword !== confirmPassword) {
            msg3.textContent = passwords_not_match_Text;
            msg3.className = "msg";
            return;
        }

        try {
            const url = `${contextPath}api/password-reset/use/${encodeURIComponent(tokenValue)}?newPassword=${encodeURIComponent(newPassword)}`;
            console.log("Resetting password:", url); // 除錯用
            
            const res = await fetch(url, {
                method: "POST"
            });

            const text = await res.text();
            console.log("Response:", res.status, text); // 除錯用
            
            if (res.ok) {
                msg3.textContent = text + redirected_login_3s_Text;
                msg3.className = "msg success";
                
                // 3秒後跳轉到登入頁
                setTimeout(() => {
                    window.location.href = contextPath + "login";
                }, 3000);
            } else {
                msg3.textContent = text || reset_failed_Text;
                msg3.className = "msg";
            }
        } catch (err) {
            console.error("Error:", err); // 除錯用
            msg3.textContent = network_error_Text + ":" + err;
            msg3.className = "msg";
        }
    }
</script>

<a th:href="@{/}" class="btn btn-outline-secondary mt-3" th:text="#{a.back}">back</a>

</body>
</html>