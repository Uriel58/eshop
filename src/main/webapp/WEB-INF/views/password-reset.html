<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>重設密碼</title>
    <link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        input { margin-bottom: 10px; width: 250px; padding: 5px; }
        button { padding: 5px 10px; }
        .msg { color: red; margin-top: 5px; }
        .msg.success { color: green; }
        .step { margin-bottom: 20px; }
    </style>
</head>
<body>
<h2>忘記密碼</h2>

<!-- Step 1：輸入 Email -->
<div id="step1" class="step">
    <p>請輸入您的 Email：</p>
    <input type="email" id="email" placeholder="請輸入 Email" required>
    <button onclick="requestCode()">取得驗證碼</button>
    <p id="msg1" class="msg"></p>
</div>

<!-- Step 2：輸入驗證碼 -->
<div id="step2" class="step" style="display:none;">
    <p>請輸入您收到的驗證碼：</p>
    <input type="text" id="token" placeholder="6位驗證碼" required>
    <button onclick="verifyCode()">驗證</button>
    <p id="msg2" class="msg"></p>
</div>

<!-- Step 3：設定新密碼 -->
<div id="step3" class="step" style="display:none;">
    <p>請輸入新密碼：</p>
    <input type="password" id="newPassword" placeholder="新密碼" required><br>
    <input type="password" id="confirmPassword" placeholder="再次輸入新密碼" required><br><br>
    <button onclick="resetPassword()">送出</button>
    <p id="msg3" class="msg"></p>
</div>

<script th:inline="javascript">
    let tokenValue = '';

    const contextPath = /*[[${#httpServletRequest.contextPath}]]*/ '';

    // Step 1：請求驗證碼
    async function requestCode() {
        const email = document.getElementById("email").value;
        const msg1 = document.getElementById("msg1");
        msg1.textContent = '';

        try {
            const res = await fetch(`${contextPath}/api/password-reset/request?email=${encodeURIComponent(email)}`, {
                method: "POST"
            });

            const text = await res.text();
            if (res.ok) {
                tokenValue = text;
                msg1.textContent = "驗證碼已產生（測試用直接顯示）：" + tokenValue;
                msg1.className = "msg success";
                document.getElementById("step1").style.display = "none";
                document.getElementById("step2").style.display = "block";
            } else {
                msg1.textContent = text;
                msg1.className = "msg";
            }
        } catch (err) {
            msg1.textContent = "網路錯誤：" + err;
        }
    }

    // Step 2：驗證驗證碼
    async function verifyCode() {
        const inputToken = document.getElementById("token").value;
        const msg2 = document.getElementById("msg2");

        try {
            const res = await fetch(`${contextPath}/api/password-reset/validate/${encodeURIComponent(inputToken)}`);
            const text = await res.text();
            if (res.ok) {
                msg2.textContent = text;
                msg2.className = "msg success";
                tokenValue = inputToken;
                document.getElementById("step2").style.display = "none";
                document.getElementById("step3").style.display = "block";
            } else {
                msg2.textContent = text;
                msg2.className = "msg";
            }
        } catch (err) {
            msg2.textContent = "網路錯誤：" + err;
        }
    }

    // Step 3：設定新密碼
    async function resetPassword() {
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;
        const msg3 = document.getElementById("msg3");

        if (newPassword !== confirmPassword) {
            msg3.textContent = "兩次密碼不一致";
            msg3.className = "msg";
            return;
        }

        try {
            const res = await fetch(`${contextPath}/api/password-reset/use/${encodeURIComponent(tokenValue)}?newPassword=${encodeURIComponent(newPassword)}`, {
                method: "POST"
            });

            const text = await res.text();
            if (res.ok) {
                msg3.textContent = text;
                msg3.className = "msg success";
            } else {
                msg3.textContent = text;
                msg3.className = "msg";
            }
        } catch (err) {
            msg3.textContent = "網路錯誤：" + err;
        }
    }
</script>
<a th:href="@{/}" class="btn btn-outline-secondary mt-3">Back to Home</a>
</body>
</html>
